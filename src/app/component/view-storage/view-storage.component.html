<div>
  <div class="flex justify-center items-center gap-2 py-1 mb-2">
    <div class="flex flex-grow items-center gap-2 py-1 max-w-60">
      <!-- Storages dropdown -->
      <details
        class="dropdown dropdown-bottom bouncy-animation relative z-40"
        [ngClass]="{
          'min-w-12 w-12': ui_isSearchExpanded,
          'w-1/5 flex-grow': !ui_isSearchExpanded
        }"
        onclick="event.preventDefault()"
        (click)="handleStorageDropdownClick()"
        #storageDropdown
      >
        <summary
          class="btn nx-btn-glass w-full pl-3"
          [attr.disabled]="storages?.length === 0 ? 'disabled' : null"
        >
          <div
            class="w-full h-full flex items-center justify-start whitespace-nowrap"
          >
            <i class="text-xl fas fa-box-open mr-3"></i>
            <span class="overflow-hidden">
              {{ this.selectedStorage?.name ?? "" }}</span
            >
          </div>
        </summary>
        <ul
          class="absolute p-2 mt-1 border-2 dropdown-content rounded-box nx-glass"
        >
          <li
            *ngFor="let storage of storages"
            class="w-full rounded-xl menu-title font-medium nx-hoverable text-gray-800"
            (click)="storageDropdownClicked(storage)"
            [ngClass]="{
                'nx-glass': storage == selectedStorage,
              }"
          >
            {{ storage.name }}
          </li>
        </ul>
      </details>

      <!-- Search -->
      <div
        class="flex items-center h-12 bouncy-animation rounded-full nx-glass nx-hoverable nx-pressable overflow-hidden"
        [ngClass]="{
          'w-1/5 flex-grow': ui_isSearchExpanded,
          'min-w-12 w-12': !ui_isSearchExpanded
        }"
        (click)="ui_isSearchExpanded = true"
      >
        <div
          class="w-full flex items-center justify-start group overflow-hidden whitespace-normal"
          (click)="ui_isSearchExpanded = true; searchInput.focus()"
        >
          <i class="fas fa-search text-xl text-gray-800 h-full mx-3"></i>
          <input
            #searchInput
            type="text"
            class="input w-full nx-placeholder-gray-800 transition-all"
            [ngClass]="{
              'bg-white/20 shadow-md': ui_isSearchExpanded,
              'bg-transparent shadow-none': !ui_isSearchExpanded
            }"
            [formControl]="searchControl"
            placeholder="Search"
          />
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2 py-1">
      <!-- Add item -->
      <button
        class="btn btn-md btn-circle nx-btn-glass flex-none"
        [disabled]="!currentUserPermissionsForSelectedStorage?.canCreateItems"
        onclick="add_item_modal.showModal()"
        (click)="clearAddItemForm()"
      >
        <i class="text-lg fa-solid fa-plus"></i>
      </button>

      <!-- Sort dropdown -->
      <div class="relative z-40 flex-none">
        <details class="dropdown dropdown-bottom dropdown-end" #sortDropdown>
          <summary
            class="btn btn-circle nx-btn-glass"
            [attr.disabled]="filteredItems?.length === 0 ? 'disabled' : null"
          >
            <i class="text-lg fa-solid fa-sort"></i>
          </summary>
          <ul class="p-2 mt-1 border-2 dropdown-content rounded-box nx-glass">
            <li
              *ngFor="let sortOption of sortOptionsArray"
              class="flex items-center w-full rounded-xl menu-title font-medium nx-hoverable text-gray-800"
              (click)="sortDropdownClicked(sortOption)"
              [ngClass]="{
                'nx-glass': sortOption === selectedSortOption
              }"
            >
              <i
                class="fa fa-solid h-full"
                [ngClass]="getSortDirectionClass(sortOption)"
              ></i>
              <span class="mx-1">{{ sortOption }}</span>
            </li>
          </ul>
        </details>
      </div>
    </div>
  </div>

  <!-- Items -->
  <div
    *ngIf="
      filteredItems?.length &&
      currentUserPermissionsForSelectedStorage?.canReadItems
    "
    class="w-full join join-vertical nx-glass"
  >
    <div *ngFor="let storageItem of filteredItems">
      <div class="px-1.5 py-0 collapse collapse-arrow join-item">
        <input type="radio" name="storage_items_accordion" />
        <!-- <input type="checkbox" /> -->
        <div class="collapse-title text-l">
          <div class="flex items-center justify-between">
            <div
              *ngIf="
                getDaysToExpire(storageItem.expirationDate) < 0;
                then expiredIcon;
                else statusCircle
              "
            ></div>

            <ng-template #statusCircle>
              <div
                class="w-6 h-6 rounded-full shadow-xl flex items-center"
                [ngClass]="getStatusCircleColorClass(storageItem)"
              >
                <span
                  class="flex items-center justify-center p-0 w-full text-xs font-semibold text-gray-800 text-rounded-full text-center"
                >
                  {{ getDaysToExpireText(storageItem.expirationDate) }}
                </span>
              </div>
            </ng-template>

            <ng-template #expiredIcon>
              <div
                class="flex items-center justify-center text-lg w-6 h-6 opacity-85"
              >
                <i class="text-red-500 fa-solid fa-exclamation-triangle"></i>
              </div>
            </ng-template>

            <span class="ml-4 font-semibold grow">{{
              storageItem.name.length <= 18
                ? storageItem.name
                : storageItem.name.slice(0, 18) + "..."
            }}</span>
            <!-- Todo find more elegant way to handle long item names (autoscroll on hold maybe?) -->

            <button
              *ngIf="currentUserPermissionsForSelectedStorage?.canUpdateItems"
              class="btn btn-sm btn-ghost"
              onclick="edit_item_modal.showModal()"
              (click)="itemSelectedForEdit = storageItem"
            >
              <i class="fa-solid fa-pencil"></i>
            </button>

            <button
              *ngIf="currentUserPermissionsForSelectedStorage?.canDeleteItems"
              class="btn btn-sm btn-ghost"
              onclick="delete_item_modal.showModal()"
              (click)="onDeleteItemClicked(storageItem)"
            >
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="collapse-content">
          <p
            class="font-semibold font-dot-matrix"
            style="letter-spacing: 0.2rem"
          >
            EXP: {{ getDateFormatted(storageItem.expirationDate) }}
          </p>
          <div
            class="w-full h-1 my-2 border-2 border-gray-800 border-dashed"
          ></div>
          <div class="flex items-center justify-between content-center">
            <p class="my-1 text-sm">
              <i class="fa-solid fa-user"></i>
              {{ storageItem.lastModifiedBy.substring(0, 28) }}
            </p>
            <p class="my-1 text-sm">
              <i class="fa-solid fa-calendar-plus"></i>
              {{ getDateFormatted(storageItem.createdAt) }}
            </p>
          </div>

          <p class="my-1 italic">
            {{ storageItem.description }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <app-add-item [selectedStorageId]="selectedStorage?.id"></app-add-item>

  <app-edit-item
    [selectedStorageId]="selectedStorage?.id"
    [itemSelectedForEdit]="itemSelectedForEdit"
  ></app-edit-item>

  <app-delete-modal
    [itemName]="itemSelectedForDelete?.name ?? ''"
    (deleteConfirmed)="onConfirmDelete()"
  ></app-delete-modal>

  <!-- Toggle button for the controls -->
  <button
    (click)="toggleBgControls()"
    class="btn btn-ghost btn-xl text-3xl btn-circle fixed bottom-20 right-4 bg-base-200/80"
    title="Background Settings"
  >
    ⚙️
  </button>

  <!-- Background filter controls -->
  <div
    *ngIf="showBgControls"
    class="fixed bottom-14 right-4 p-3 rounded-lg bg-base-200/80 shadow-lg w-64 z-50"
  >
    <div class="flex justify-between mb-2">
      <h3 class="text-sm font-bold">Background Controls</h3>
      <button (click)="toggleBgControls()" class="btn btn-xs btn-circle">
        ✕
      </button>
    </div>

    <div class="form-control">
      <label class="label py-0">
        <span class="label-text text-xs">Blur: {{ blur }}px</span>
      </label>
      <input
        type="range"
        min="0"
        max="20"
        [(ngModel)]="blur"
        (ngModelChange)="updateBgFilters()"
        class="range range-xs"
      />
    </div>

    <div class="form-control">
      <label class="label py-0">
        <span class="label-text text-xs">Hue: {{ hueRotate }}°</span>
      </label>
      <input
        type="range"
        min="0"
        max="360"
        [(ngModel)]="hueRotate"
        (ngModelChange)="updateBgFilters()"
        class="range range-xs"
      />
    </div>

    <div class="form-control">
      <label class="label py-0">
        <span class="label-text text-xs">Saturation: {{ saturation }}</span>
      </label>
      <input
        type="range"
        min="0"
        max="3"
        step="0.1"
        [(ngModel)]="saturation"
        (ngModelChange)="updateBgFilters()"
        class="range range-xs"
      />
    </div>

    <div class="form-control">
      <label class="label py-0">
        <span class="label-text text-xs">Contrast: {{ contrast }}</span>
      </label>
      <input
        type="range"
        min="0"
        max="2"
        step="0.1"
        [(ngModel)]="contrast"
        (ngModelChange)="updateBgFilters()"
        class="range range-xs"
      />
    </div>

    <div class="form-control">
      <label class="label py-0">
        <span class="label-text text-xs">Brightness: {{ brightness }}</span>
      </label>
      <input
        type="range"
        min="0.5"
        max="2"
        step="0.1"
        [(ngModel)]="brightness"
        (ngModelChange)="updateBgFilters()"
        class="range range-xs"
      />
    </div>

    <div class="mt-2">
      <p class="text-xs font-mono break-all opacity-80">
        filter: {{ blur }}px {{ hueRotate }}deg {{ saturation }}
        {{ contrast }}
        {{ brightness }}
      </p>
    </div>
  </div>
  <!-- End Background Filter Controls -->
</div>
